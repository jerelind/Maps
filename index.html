<!DOCTYPE html>
<html>
<style>

#googleMap {
    width: 600px;
    height: 400px;
    position: absolute;
}

#places {
    margin-left: 620px;
}

#placeList {
    padding: 5px;
    border-left: 0.2px solid black;
}

p {
    margin: 5px;
    font-size: 20px;
}

#content {
    text-align: center;
}

.coordinates {
    font-size: 13px;
}

.title {
    margin-bottom: -5px;
}

</style>
<body>

<h1>My First Google Map</h1>
<button onclick="removeAllMarkers()">Remove all markers</button>

<div id="googleMap"></div>
<div id="places">
    <!-- <button onclick="toggleVisibility()">Show/Hide</button> -->
    <input type="text" id="filter" onkeyup="filter('filter')" placeholder="Filter by title">
    <input type="text" id="hourFilter" onkeyup="filter('hourFilter')" placeholder="Filter by hours">
    <div id="placeList"></div>
</div>

<script>
let markers = []

initMap = () => {
    const mapProp = {
        center: new google.maps.LatLng(60.15639617730196, 24.90949634304809),
        zoom: 11
    }

    const map = new google.maps.Map(document.getElementById("googleMap"), mapProp)

    for(let i = 0; i < localStorage.length; i++) {
        //parse localStorage values and set variables for marker
        const values = JSON.parse(localStorage.getItem(i))
        const lat = values[0].lat
        const lng = values[0].lng
        const coords = new google.maps.LatLng(lat, lng)
        const title = values[1]
        const desc = values[2]
        const hours = values[3]
        //console.log(title)
        addMarker({
            map: map,
            coords: coords,
            title: title,
            desc: desc,
            hours: hours
        })
    }

    google.maps.event.addListener(map, 'click', (event) => {
    // Add marker
        addMarker({
            map: map, 
            coords: event.latLng,
            title: "Untitled place",
            desc: "No description yet",
            hours: "Open: -"
        })
    })

    updatePlaces()
}

//function for adding markers to map
addMarker = (props) => {
    const infoWindow = new google.maps.InfoWindow({
        content: null
    })

    const marker = new google.maps.Marker({
        id: markers.length,
        title: props.title,
        desc: props.desc,
        hours: props.hours,
        position: props.coords,
        map: props.map,
        info: infoWindow
    })

    //set infoWindow content
    marker.info.setContent(
        `
        <div id="content">
            <h1 class="title">${marker.title}</h1>
            <p class="coordinates">${marker.position}</p>
            <div>
                <input id="title-${marker.id}" type="text" placeholder="New title">
                <button onclick="updateTitle(${marker.id})">Add</button>
            </div>
            <div>
                <input id="desc-${marker.id}" type="text" placeholder="New description">
                <button onclick="updateDesc(${marker.id})">Add</button>
            </div>
            <div>
                <input id="hours-${marker.id}" type="text" placeholder="New hours">
                <button onclick="updateHours(${marker.id})">Add</button>
            </div>
            <p>${marker.desc}</p>
            <p>Open: ${marker.hours}</p>
        </div>
        `
    )

    //event listeners for markers
    marker.addListener('click', () => {
        marker.info.open(props.map, marker)
    })

    marker.addListener('dblclick', () => {
        removeMarker(marker.id)
        marker.setMap(null)
    })

    markers.push(marker)
    updatePlaces()

    //set marker values to localStorage
    const values = [marker.position, marker.title, marker.desc, marker.hours]

    localStorage.setItem(marker.id, JSON.stringify(values))

}

removeAllMarkers = () => {
    for(let i = 0; i < markers.length; i++) {
        markers[i].setMap(null)
    }
    markers = []
    localStorage.clear()
    updatePlaces()
}

updateTitle = (id) => {
    markers[id].title = document.getElementById(`title-${id}`).value
    setContent(id)
    updatePlaces()
    
    //change localStorage value of title
    const values = JSON.parse(localStorage.getItem(id))
    values[1] = markers[id].title
    localStorage.setItem(id, JSON.stringify(values))
    console.log(values)
}

updateDesc = (id) => {
    markers[id].desc = document.getElementById(`desc-${id}`).value
    setContent(id)

    //change localStorage value of desc
    const values = JSON.parse(localStorage.getItem(id))
    values[2] = markers[id].desc
    localStorage.setItem(id, JSON.stringify(values))
    console.log(values)
}

updateHours = (id) => {
    markers[id].hours = document.getElementById(`hours-${id}`).value
    setContent(id)
    updatePlaces()

    //change localStorage value of hours
    const values = JSON.parse(localStorage.getItem(id))
    values[3] = markers[id].hours
    localStorage.setItem(id, JSON.stringify(values))
    console.log(values)
}

//check for changes in marker props and render title&hours beside the map 
updatePlaces = () => {
    if(markers.length > 0) {
        document.getElementById("placeList").innerHTML = markers.map(m => `<p>${m.title}<br/> Open: ${m.hours}</p>`).join("")
    } else {
        document.getElementById("placeList").innerHTML = "No places"
    }
}

removeMarker = (id) => {

    //find the index of the marker to be removed
    const index = markers.findIndex(m => m.id === id)
    //console.log(index)
    //remove the marker from markers array
    markers.splice(index, 1)
    localStorage.removeItem(id)
    updatePlaces()

}

// toggleVisibility = () => {
//     if(document.getElementById("placeList").style.visibility === "visible") {
//         document.getElementById("placeList").style.visibility = "hidden"
//     } else {
//         document.getElementById("placeList").style.visibility = "visible"
//     }
// }

//function for setting infowindow content by marker ID
setContent = (id) => {
    markers[id].info.setContent(
    `
    <div id="content">
        <h1 class="title">${markers[id].title}</h1>
        <p class="coordinates">${markers[id].position}</p>
        <div>
            <input id="title-${id}" type="text" placeholder="New title">
            <button onclick="updateTitle(${id})">Add</button>
        </div>
        <div>
            <input id="desc-${id}" type="text" placeholder="New description">
            <button onclick="updateDesc(${id})">Add</button>
        </div>
        <div>
            <input id="hours-${id}" type="text" placeholder="New hours">
            <button onclick="updateHours(${id})">Add</button>
        </div>
        <p>${markers[id].desc}</p>
        <p>Open: ${markers[id].hours}</p>
    </div>
    `
    )
}

//function for filtering the list of places by filter input
filter = (filterId) => {
    let input, filter, div, p, x, i, textValue
    input = document.getElementById(filterId)
    filter = input.value.toUpperCase()
    div = document.getElementById("placeList")
    p = div.getElementsByTagName("p")
    
    for(i = 0; i < p.length; i++) {
        x = p[i]
        textValue = x.textContent || x.innerText
        if(textValue.toUpperCase().indexOf(filter) > -1) {
            p[i].style.visibility = "visible"
        } else {
            p[i].style.visibility = "hidden"
        }
    }
}

//console.log(markers)

</script>

<script src="https://maps.googleapis.com/maps/api/js?key=API_KEY&callback=initMap"></script>

</body>
</html>