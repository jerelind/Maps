<!DOCTYPE html>
<html>
<style>
body {
    text-align: center;
}

p {
    margin: 5px;
    font-size: 20px;
}

button {
    font-size: 15px;
}

input {
    font-size: 15px;
    border-radius: 5px;
}

#googleMap {
    width: 800px;
    height: 600px;
    margin-left: auto;
    margin-right: auto;
}

#filters {
    margin-bottom: 10px;
}

#infoContent {
    text-align: center;
}

.coordinates {
    font-size: 13px;
    margin-bottom: 5px;
}

.infoTitle {
    margin-bottom: -5px;
}

.headTitle {
    font-family: "Indie Flower"
}

</style>
<body>

<h1 class="headTitle">Super awesome Google Maps App</h1>
<div id="filters">
    <button onclick="removeAllMarkers()">Remove all markers</button>
    <input type="text" id="titleFilter" onkeyup="filter('titleFilter')" placeholder="Filter places by title">
    <input type="number" id="hourFilter" onkeyup="filter('hourFilter')" placeholder="Filter places by hours">
</div>

<div id="googleMap"></div>
<!-- <div id="places">
    <button onclick="toggleVisibility()">Show/Hide</button> -->
    <!-- <div id="placeList"></div>
</div> -->

<script>
let markers = []

initMap = () => {
    const mapProp = {
        center: new google.maps.LatLng(60.15639617730196, 24.90949634304809),
        zoom: 11
    }

    const map = new google.maps.Map(document.getElementById("googleMap"), mapProp)

    for(let i = 0; i < localStorage.length; i++) {
        //parse localStorage values and set variables for marker
        const values = JSON.parse(localStorage.getItem(i))
        const lat = values[0].lat
        const lng = values[0].lng
        const coords = new google.maps.LatLng(lat, lng)
        const title = values[1]
        const desc = values[2]
        const openingHour = Number(values[3])
        const closingHour = Number(values[4])
        //console.log(title)
        addMarker({
            map: map,
            coords: coords,
            title: title,
            desc: desc,
            openingHour: openingHour,
            closingHour: closingHour
        })
    }

    google.maps.event.addListener(map, 'click', (event) => {
    // Add marker
        addMarker({
            map: map, 
            coords: event.latLng,
            title: "Untitled place",
            desc: "No description yet",
            openingHour: "",
            closingHour: ""
        })
    })

    // updatePlaces()
}

//function for adding markers to map
addMarker = (props) => {
    const infoWindow = new google.maps.InfoWindow({
        content: null
    })

    const marker = new google.maps.Marker({
        id: markers.length,
        title: props.title,
        desc: props.desc,
        openingHour: props.openingHour,
        closingHour: props.closingHour,
        position: props.coords,
        map: props.map,
        info: infoWindow
    })

    //set infoWindow content
    marker.info.setContent(
        `
        <div id="infoContent">
            <h1 class="infoTitle">${marker.title}</h1>
            <p class="coordinates">${marker.position}</p>
            <div>
                <input id="title-${marker.id}" type="text" placeholder="New title">
                <button onclick="updateTitle(${marker.id})">Add</button>
            </div>
            <div>
                <input id="desc-${marker.id}" type="text" placeholder="New description">
                <button onclick="updateDesc(${marker.id})">Add</button>
            </div>
            <div>
                <input id="openingHour-${marker.id}" type="number" placeholder="New opening hour">
                <button onclick="updateOpeningHour(${marker.id})">Add</button>
            </div>
            <div>
                <input id="closingHour-${marker.id}" type="number" placeholder="New closing hour">
                <button onclick="updateClosingHour(${marker.id})">Add</button>
            </div>
            <p>${marker.desc}</p>
            <p>Open: ${marker.openingHour}-${marker.closingHour}</p>
        </div>
        `
    )

    //event listeners for markers
    marker.addListener('click', () => {
        marker.info.open(props.map, marker)
    })

    marker.addListener('dblclick', () => {
        removeMarker(marker.id)
        marker.setMap(null)
    })

    markers.push(marker)
    // updatePlaces()

    //set marker values to localStorage
    const values = [marker.position, marker.title, marker.desc, marker.openingHour, marker.closingHour]

    localStorage.setItem(marker.id, JSON.stringify(values))

}

removeAllMarkers = () => {
    for(let i = 0; i < markers.length; i++) {
        markers[i].setMap(null)
    }
    markers = []
    localStorage.clear()
    // updatePlaces()
}

updateTitle = (id) => {
    markers[id].title = document.getElementById(`title-${id}`).value
    setContent(id)
    // updatePlaces()
    
    //change localStorage value of title
    const values = JSON.parse(localStorage.getItem(id))
    values[1] = markers[id].title
    localStorage.setItem(id, JSON.stringify(values))
}

updateDesc = (id) => {
    markers[id].desc = document.getElementById(`desc-${id}`).value
    setContent(id)

    //change localStorage value of desc
    const values = JSON.parse(localStorage.getItem(id))
    values[2] = markers[id].desc
    localStorage.setItem(id, JSON.stringify(values))
}

updateOpeningHour = (id) => {
    markers[id].openingHour = document.getElementById(`openingHour-${id}`).value
    setContent(id)
    // updatePlaces()

    //change localStorage value of hours
    const values = JSON.parse(localStorage.getItem(id))
    values[3] = markers[id].openingHour
    localStorage.setItem(id, JSON.stringify(values))
}

updateClosingHour = (id) => {
    markers[id].closingHour = document.getElementById(`closingHour-${id}`).value
    setContent(id)

    const values = JSON.parse(localStorage.getItem(id))
    values[4] = markers[id].closingHour
    localStorage.setItem(id, JSON.stringify(values))
}

//check for changes in marker props and render title&hours beside the map 
// updatePlaces = () => {
//     if(markers.length > 0) {
//         document.getElementById("placeList").innerHTML = markers.map(m => `<p>${m.title}<br/> Open: ${m.hours}</p>`).join("")
//     } else {
//         document.getElementById("placeList").innerHTML = "No places"
//     }
// }

removeMarker = (id) => {

    //find the index of the marker to be removed
    const index = markers.findIndex(m => m.id === id)
    //console.log(index)
    //remove the marker from markers array
    markers.splice(index, 1)
    localStorage.removeItem(id)
    // updatePlaces()
}

// toggleVisibility = () => {
//     if(document.getElementById("placeList").style.visibility === "visible") {
//         document.getElementById("placeList").style.visibility = "hidden"
//     } else {
//         document.getElementById("placeList").style.visibility = "visible"
//     }
// }

//function for setting infowindow content by marker ID
setContent = (id) => {
    markers[id].info.setContent(
    `
    <div id="infoContent">
        <h1 class="infoTitle">${markers[id].title}</h1>
        <p class="coordinates">${markers[id].position}</p>
        <div>
            <input id="title-${id}" type="text" placeholder="New title">
            <button onclick="updateTitle(${id})">Add</button>
        </div>
        <div>
            <input id="desc-${id}" type="text" placeholder="New description">
            <button onclick="updateDesc(${id})">Add</button>
        </div>
        <div>
            <input id="openingHour-${id}" type="number" placeholder="New opening hour">
            <button onclick="updateOpeningHour(${id})">Add</button>
        </div>
        <div>
            <input id="closingHour-${id}" type="number" placeholder="New closing hour">
            <button onclick="updateClosingHour(${id})">Add</button>
        </div>
        <p>${markers[id].desc}</p>
        <p>Open: ${markers[id].openingHour}-${markers[id].closingHour}</p>
    </div>
    `
    )
}

//function for filtering the list of places by filter input
filter = (filterId) => {
    const input = document.getElementById(filterId)
    let filter = input.value.toUpperCase()

    // console.log(filterId)

    if(filterId === "titleFilter") {
        for(let i = 0; i < markers.length; i++) {
            const textValue = markers[i].title
            if(textValue.toUpperCase().indexOf(filter) > -1) {
                markers[i].setVisible(true)
            } else {
                markers[i].setVisible(false)
                markers[i].info.close()
            }
        }
    }

    if(filterId === "hourFilter") {
        for(let j = 0; j < markers.length; j++) {
            const openingHour = markers[j].openingHour
            const closingHour = markers[j].closingHour

            if(filter >= openingHour && filter <= closingHour) {
                markers[j].setVisible(true)
            } else if(filter.length === 0 ){
                markers[j].setVisible(true)
            } else {
                markers[j].setVisible(false)
                markers[j].info.close()
            }
        }
    }
}


</script>

<script src="https://maps.googleapis.com/maps/api/js?key=API_KEY&callback=initMap"></script>
<link href="https://fonts.googleapis.com/css?family=Indie+Flower" rel="stylesheet">

</body>
</html>